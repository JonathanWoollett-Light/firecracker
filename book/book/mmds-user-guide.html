<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>MMDS User Guide - Firecracker</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="CHARTER.html"><strong aria-hidden="true">2.</strong> Firecracker Charter</a></li><li class="chapter-item expanded "><a href="CODE_OF_CONDUCT.html"><strong aria-hidden="true">3.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="SECURITY.html"><strong aria-hidden="true">4.</strong> Security</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">5.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">6.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="dev-machine-setup.html"><strong aria-hidden="true">7.</strong> Development Machine Setup</a></li><li class="chapter-item expanded "><a href="api-change-runbook.html"><strong aria-hidden="true">8.</strong> API Change Runbook</a></li><li class="chapter-item expanded "><a href="RELEASE_POLICY.html"><strong aria-hidden="true">9.</strong> Releases</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">10.</strong> Design</a></li><li class="chapter-item expanded "><a href="prod-host-setup.html"><strong aria-hidden="true">11.</strong> Production Host Setup</a></li><li class="chapter-item expanded "><a href="network-setup.html"><strong aria-hidden="true">12.</strong> Network Setup</a></li><li class="chapter-item expanded "><a href="kernel-policy.html"><strong aria-hidden="true">13.</strong> Kernel Support Policy</a></li><li class="chapter-item expanded "><a href="SPECIFICATION.html"><strong aria-hidden="true">14.</strong> Specification</a></li><li class="chapter-item expanded "><a href="network-performance.html"><strong aria-hidden="true">15.</strong> Network Performance</a></li><li class="chapter-item expanded "><a href="FAQ.html"><strong aria-hidden="true">16.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="rootfs-and-kernel-setup.html"><strong aria-hidden="true">17.</strong> Creating Custom rootfs and kernel Images</a></li><li class="chapter-item expanded "><a href="ballooning.html"><strong aria-hidden="true">18.</strong> Ballooning</a></li><li class="chapter-item expanded "><a href="devctr-image.html"><strong aria-hidden="true">19.</strong> Development Container</a></li><li class="chapter-item expanded "><a href="device-api.html"><strong aria-hidden="true">20.</strong> Device API</a></li><li class="chapter-item expanded "><a href="entropy.html"><strong aria-hidden="true">21.</strong> Entropy</a></li><li class="chapter-item expanded "><a href="formal-verification.html"><strong aria-hidden="true">22.</strong> Formal Verification</a></li><li class="chapter-item expanded "><a href="initrd.html"><strong aria-hidden="true">23.</strong> initrd</a></li><li class="chapter-item expanded "><a href="jailer.html"><strong aria-hidden="true">24.</strong> Jailer</a></li><li class="chapter-item expanded "><a href="logger.html"><strong aria-hidden="true">25.</strong> Logger</a></li><li class="chapter-item expanded "><a href="metrics.html"><strong aria-hidden="true">26.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="seccomp.html"><strong aria-hidden="true">27.</strong> Seccomp</a></li><li class="chapter-item expanded "><a href="seccompiler.html"><strong aria-hidden="true">28.</strong> Seccompiler</a></li><li class="chapter-item expanded "><a href="tracing.html"><strong aria-hidden="true">29.</strong> Tracing</a></li><li class="chapter-item expanded "><a href="vsock.html"><strong aria-hidden="true">30.</strong> VSock</a></li><li class="chapter-item expanded "><a href="api-requests.html"><strong aria-hidden="true">31.</strong> API Requests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="actions.html"><strong aria-hidden="true">31.1.</strong> Actons</a></li><li class="chapter-item expanded "><a href="block-caching.html"><strong aria-hidden="true">31.2.</strong> Block Caching</a></li><li class="chapter-item expanded "><a href="block-io-engine.html"><strong aria-hidden="true">31.3.</strong> Block IO Engine</a></li><li class="chapter-item expanded "><a href="block-vhost-user.html"><strong aria-hidden="true">31.4.</strong> Block VHost User</a></li><li class="chapter-item expanded "><a href="patch-block.html"><strong aria-hidden="true">31.5.</strong> Patch Block</a></li><li class="chapter-item expanded "><a href="patch-network-interface.html"><strong aria-hidden="true">31.6.</strong> Patch Network Interface</a></li></ol></li><li class="chapter-item expanded "><a href="state-serialize.html"><strong aria-hidden="true">32.</strong> State Serialization Benchmarks</a></li><li class="chapter-item expanded "><a href="cpu-templates.html"><strong aria-hidden="true">33.</strong> CPU Templates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="boot-protocol.html"><strong aria-hidden="true">33.1.</strong> Boot Protocol</a></li><li class="chapter-item expanded "><a href="cpu-template-helper.html"><strong aria-hidden="true">33.2.</strong> CPU Template Helper</a></li><li class="chapter-item expanded "><a href="cpuid-normalization.html"><strong aria-hidden="true">33.3.</strong> CPUID Normalization</a></li></ol></li><li class="chapter-item expanded "><a href="mmds.html"><strong aria-hidden="true">34.</strong> MMDS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mmds-design.html"><strong aria-hidden="true">34.1.</strong> MMDS Design</a></li><li class="chapter-item expanded "><a href="mmds-user-guide.html" class="active"><strong aria-hidden="true">34.2.</strong> MMDS User Guide</a></li></ol></li><li class="chapter-item expanded "><a href="snapshotting.html"><strong aria-hidden="true">35.</strong> Snapshotting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="handling-page-faults-on-snapshot-resume.html"><strong aria-hidden="true">35.1.</strong> Handling Page Faults on Snapshot Resume</a></li><li class="chapter-item expanded "><a href="network-for-clones.html"><strong aria-hidden="true">35.2.</strong> Network For Clones</a></li><li class="chapter-item expanded "><a href="random-for-clones.html"><strong aria-hidden="true">35.3.</strong> Random For Clones</a></li><li class="chapter-item expanded "><a href="snapshot-editor.html"><strong aria-hidden="true">35.4.</strong> Snapshot Editor</a></li><li class="chapter-item expanded "><a href="snapshot-support.html"><strong aria-hidden="true">35.5.</strong> Snapshot Support</a></li><li class="chapter-item expanded "><a href="versioning.html"><strong aria-hidden="true">35.6.</strong> Versioning</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Firecracker</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="microvm-metadata-service"><a class="header" href="#microvm-metadata-service">microVM Metadata Service</a></h1>
<p>The Firecracker microVM Metadata Service (MMDS) is a mutable data store which
can be used for sharing information between host and guests, in a secure and
easy at hand way.</p>
<h2 id="configuring-and-activating-the-microvm-metadata-service"><a class="header" href="#configuring-and-activating-the-microvm-metadata-service">Configuring and activating the microVM Metadata Service</a></h2>
<p>By default, MMDS is not reachable from the guest operating system. At microVM
runtime, MMDS is tightly coupled with a network interface, which allows MMDS
requests. When configuring the microVM, if MMDS needs to be activated, a
network interface has to be configured to allow MMDS requests. This can be
achieved in two steps:</p>
<ol>
<li>Attach one (or more) network interfaces through an HTTP <code>PUT</code> request to
<code>/network-interfaces/${MMDS_NET_IF}</code>. The full network configuration API
can be found in the <a href="../../src/api_server/swagger/firecracker.yaml">firecracker swagger file</a>.</li>
<li>Configure MMDS through an HTTP <code>PUT</code> request to <code>/mmds/config</code> resource and
include the IDs of the network interfaces that should allow forwarding requests
to MMDS in the <code>network_interfaces</code> list. The complete MMDS API is described in
the <a href="../../src/api_server/swagger/firecracker.yaml">firecracker swagger file</a>.</li>
</ol>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<p>Attaching a network device with ID <code>MMDS_NET_IF</code>:</p>
<pre><code class="language-bash">MMDS_NET_IF=eth0
curl --unix-socket /tmp/firecracker.socket -i                 \
  -X PUT 'http://localhost/network-interfaces/${MMDS_NET_IF}' \
  -H 'Accept: application/json'                               \
  -H 'Content-Type: application/json'                         \
  -d '{
      &quot;iface_id&quot;: &quot;${MMDS_NET_IF}&quot;,
      &quot;guest_mac&quot;: &quot;AA:FC:00:00:00:01&quot;,
      &quot;host_dev_name&quot;: &quot;tap0&quot;
    }'
</code></pre>
<p>Configuring MMDS to receive requests through the <code>MMDS_NET_IF</code> network
interface ID:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
curl --unix-socket /tmp/firecracker.socket -i \
    -X PUT &quot;http://localhost/mmds/config&quot;     \
    -H &quot;Content-Type: application/json&quot;       \
    -d '{
             &quot;network_interfaces&quot;: [&quot;${MMDS_NET_IF}&quot;]
    }'
</code></pre>
<p>MMDS can be configured pre-boot only, using the Firecracker API server. Enabling
MMDS without at least a network device attached will return an error.</p>
<p>The IPv4 address used by guest applications when issuing requests to MMDS can
be customized through the same HTTP <code>PUT</code> request to <code>/mmds/config</code> resource,
by specifying the IPv4 address to the <code>ipv4_address</code> field. If the IP configuration
is not provided before booting up the guest, the MMDS IPv4 address defaults to
<code>169.254.169.254</code>.</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
curl --unix-socket /tmp/firecracker.socket -i \
    -X PUT &quot;http://localhost/mmds/config&quot;     \
    -H &quot;Content-Type: application/json&quot;       \
    -d '{
             &quot;network_interfaces&quot;: [&quot;${MMDS_NET_IF}&quot;],
             &quot;ipv4_address&quot;: &quot;${MMDS_IPV4_ADDR}&quot;
    }'
</code></pre>
<p>MMDS is tightly coupled with a network interface which is used to route MMDS
packets. To send MMDS intended packets, guest applications must insert a new
rule into the routing table of the guest OS. This new rule must forward MMDS
intended packets to a network interface which allows MMDS requests. For
example:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
MMDS_NET_IF=eth0
ip route add ${MMDS_IPV4_ADDR} dev ${MMDS_NET_IF}
</code></pre>
<p>MMDS supports two methods to access the contents of the metadata store from the
guest operating system: <code>V1</code> and <code>V2</code>.
More about the particularities of the two mechanisms can be found in the
<a href="#retrieving-metadata-in-the-guest-operating-system">Retrieving metadata in the guest operating system</a>
section. The MMDS version used can be specified when configuring MMDS, through
the <code>version</code> field of the HTTP <code>PUT</code> request to <code>/mmds/config</code> resource.
Accepted values are <code>V1</code>(deprecated) and <code>V2</code> and the default MMDS version used
in case the <code>version</code> field is missing is <a href="#version-1-deprecated">Version 1</a>.</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
curl --unix-socket /tmp/firecracker.socket -i \
    -X PUT &quot;http://localhost/mmds/config&quot;     \
    -H &quot;Content-Type: application/json&quot;       \
    -d '{
             &quot;network_interfaces&quot;: [&quot;${MMDS_NET_IF}&quot;],
             &quot;version&quot;: &quot;V2&quot;,
             &quot;ipv4_address&quot;: &quot;${MMDS_IPV4_ADDR}&quot;
    }'
</code></pre>
<h2 id="inserting-and-updating-metadata"><a class="header" href="#inserting-and-updating-metadata">Inserting and updating metadata</a></h2>
<p>Inserting and updating metadata is possible through the Firecracker API server.
The metadata inserted in MMDS must be any valid JSON. A user can create or update
the MMDS data store before the microVM is started or during its operation. To
insert metadata into MMDS, an HTTP <code>PUT</code> request to the <code>/mmds</code> resource has to be
issued. This request must have a payload with metadata structured in
<a href="https://tools.ietf.org/html/rfc7159">JSON</a> format. To replace existing
metadata, a subsequent HTTP <code>PUT</code> request to the <code>/mmds</code> resource must be
issued, using as a payload the new metadata. A complete description of
metadata insertion firecracker API can be found in the
<a href="../../src/api_server/swagger/firecracker.yaml">firecracker swagger file</a>.</p>
<p>An example of an API request for inserting metadata is provided below:</p>
<pre><code class="language-bash">curl --unix-socket /tmp/firecracker.socket -i \
    -X PUT &quot;http://localhost/mmds&quot;            \
    -H &quot;Content-Type: application/json&quot;       \
    -d '{
            &quot;latest&quot;: {
                  &quot;meta-data&quot;: {
                       &quot;ami-id&quot;: &quot;ami-12345678&quot;,
                       &quot;reservation-id&quot;: &quot;r-fea54097&quot;,
                       &quot;local-hostname&quot;: &quot;ip-10-251-50-12.ec2.internal&quot;,
                       &quot;public-hostname&quot;: &quot;ec2-203-0-113-25.compute-1.amazonaws.com&quot;,
                       &quot;network&quot;: {
                            &quot;interfaces&quot;: {
                                 &quot;macs&quot;: {
                                      &quot;02:29:96:8f:6a:2d&quot;: {
                                           &quot;device-number&quot;: &quot;13345342&quot;,
                                           &quot;local-hostname&quot;: &quot;localhost&quot;,
                                           &quot;subnet-id&quot;: &quot;subnet-be9b61d&quot;
                                      }
                                 }
                            }
                       }
                  }
            }
    }'
</code></pre>
<p>To partially update existing metadata, an HTTP <code>PATCH</code> request to the <code>/mmds</code>
resource has to be issued, using as a payload the metadata patch, as
<a href="https://tools.ietf.org/html/rfc7396">JSON Merge Patch</a> functionality
describes. A complete description of updating metadata Firecracker API can be
found in the <a href="../../src/api_server/swagger/firecracker.yaml">firecracker swagger file</a>.</p>
<p>An example API for how to update existing metadata is offered below:</p>
<pre><code class="language-bash">curl --unix-socket /tmp/firecracker.socket -i \
    -X PATCH &quot;http://localhost/mmds&quot;          \
    -H &quot;Content-Type: application/json&quot;       \
    -d '{
            &quot;latest&quot;: {
                  &quot;meta-data&quot;: {
                       &quot;ami-id&quot;: &quot;ami-87654321&quot;,
                       &quot;reservation-id&quot;: &quot;r-79054aef&quot;,
                  }
            }
    }'
</code></pre>
<h2 id="retrieving-metadata"><a class="header" href="#retrieving-metadata">Retrieving metadata</a></h2>
<p>MicroVM metadata can be retrieved both from host and guest operating systems.
For the scope of this chapter, let's assume the data store content is the JSON
below:</p>
<pre><code class="language-json">{
    &quot;latest&quot;: {
          &quot;meta-data&quot;: {
               &quot;ami-id&quot;: &quot;ami-87654321&quot;,
               &quot;reservation-id&quot;: &quot;r-79054aef&quot;
          }
    }
}
</code></pre>
<h3 id="retrieving-metadata-in-the-host-operating-system"><a class="header" href="#retrieving-metadata-in-the-host-operating-system">Retrieving metadata in the host operating system</a></h3>
<p>To retrieve existing MMDS metadata from host operating system, an HTTP <code>GET</code>
request to the <code>/mmds</code> resource must be issued. The HTTP response returns the
existing metadata, as a JSON formatted text. A complete description of
retrieving metadata Firecracker API can be found in the
<a href="../../src/api_server/swagger/firecracker.yaml">firecracker swagger file</a>.</p>
<p>Below you can see how to retrieve metadata from the host:</p>
<pre><code class="language-bash">curl -s --unix-socket /tmp/firecracker.socket http://localhost/mmds
</code></pre>
<p>Output:</p>
<pre><code class="language-json">{
    &quot;latest&quot;: {
          &quot;meta-data&quot;: {
               &quot;ami-id&quot;: &quot;ami-87654321&quot;,
               &quot;reservation-id&quot;: &quot;r-79054aef&quot;
          }
    }
}
</code></pre>
<h3 id="retrieving-metadata-in-the-guest-operating-system"><a class="header" href="#retrieving-metadata-in-the-guest-operating-system">Retrieving metadata in the guest operating system</a></h3>
<p>Accessing the contents of the metadata store from the guest operating system
can be done using one of the following methods:</p>
<ul>
<li><code>V1</code>: simple request/response method (deprecated)</li>
<li><code>V2</code>: session-oriented method</li>
</ul>
<h4 id="version-1-deprecated"><a class="header" href="#version-1-deprecated">Version 1 (Deprecated)</a></h4>
<p><strong>Version 1 is deprecated and will be removed in the next major version change.
Version 2 should be used instead.</strong></p>
<p>To retrieve existing MMDS metadata using MMDS version 1, an HTTP <code>GET</code>
request must be issued. The requested resource can be referenced by its
corresponding <a href="https://tools.ietf.org/html/rfc6901">JSON Pointer</a>, which is
also the path of the MMDS request. The HTTP response content will contain the
referenced metadata resource.</p>
<p>The only HTTP method supported by MMDS version 1 is <code>GET</code>. Requests containing
any other HTTP method will receive <strong>405 Method Not Allowed</strong> error.</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER_OBJ=latest/meta-data
curl -s &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER_OBJ}&quot;
</code></pre>
<h4 id="version-2"><a class="header" href="#version-2">Version 2</a></h4>
<p>Similar to <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html">IMDSv2</a>,
MMDS version 2 (<code>V2</code>) is a session oriented method, which makes use of a session
token in order to allow fetching metadata contents.</p>
<p>The session must start with an HTTP <code>PUT</code> request that generates the session token.
In order to be successful, the request must respect the following constraints:</p>
<ul>
<li>must be directed towards <code>/latest/api/token</code> path</li>
<li>must contain a <code>X-metadata-token-ttl-seconds</code> header specifying the token lifetime
in seconds. The value cannot be lower than 1 or greater than 21600 (6 hours).</li>
<li>must not contain a <code>X-Forwarded-For</code> header.</li>
</ul>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
TOKEN=`curl -X PUT &quot;http://${MMDS_IPV4_ADDR}/latest/api/token&quot; \
      -H &quot;X-metadata-token-ttl-seconds: 21600&quot;`
</code></pre>
<p>The HTTP response from MMDS is a plaintext containing the session token.</p>
<p>During the duration specified by the token's time to live value, all subsequent
<code>GET</code> requests must specify the session token through the <code>X-metadata-token</code>
header in order to fetch data from MMDS.</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER_OBJ=latest/meta-data
curl -s &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER_OBJ}&quot; \
    -H &quot;X-metadata-token: ${TOKEN}&quot;
</code></pre>
<p>After the token expires, it becomes unusable and a new session token must be issued.</p>
<h5 id="snapshotting-considerations"><a class="header" href="#snapshotting-considerations">Snapshotting considerations</a></h5>
<p>The data store is <strong>not</strong> persisted across snapshots, in order to avoid leaking
vm-specific information that may need to be reseeded into the data store for
a new clone.</p>
<p>The MMDS version, network stack configuration and IP address used for accessing the
service are persisted across snapshot-restore.</p>
<p>If the targeted snapshot version does not support Mmds Version 2, it will not be
persisted in the snapshot (the clone will use the default, V1). Similarly, if a
snapshotted Vm state contains the Mmds version but the Firecracker version used
for restoring does not support persisting the version, the default will be used.</p>
<h3 id="mmds-formats"><a class="header" href="#mmds-formats">MMDS formats</a></h3>
<p>The response format can be JSON or IMDS. The IMDS documentation
can be found <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html">here</a>.
The output format can be selected by specifying the optional <code>Accept</code> header.
Using <code>Accept: application/json</code> will format the output to JSON, while using
<code>Accept: plain/text</code> or not specifying this optional header at all will format
the output to IMDS.</p>
<p>Retrieving MMDS resources in IMDS format, other than JSON <code>string</code> and <code>object</code> types,
is not supported.</p>
<p>Below is an example on how to retrieve the <code>latest/meta-data</code> resource in
JSON format:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER_OBJ=latest/meta-data
curl -s -H &quot;Accept: application/json&quot; &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER_OBJ}&quot;
</code></pre>
<p>Output:</p>
<pre><code class="language-json">{
    &quot;ami-id&quot;: &quot;ami-87654321&quot;,
    &quot;reservation-id&quot;: &quot;r-79054aef&quot;
}
</code></pre>
<p>Retrieving the <code>latest/meta-data/ami-id</code> resource in JSON format:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER_STR=latest/meta-data/ami-id
curl -s -H &quot;Accept: application/json&quot; &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER_STR}&quot;
</code></pre>
<p>Output:</p>
<pre><code class="language-json">&quot;ami-87654321&quot;
</code></pre>
<p>Retrieving the <code>latest</code> resource in IMDS format:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER=latest
curl -s &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER}&quot;
</code></pre>
<p>Output:</p>
<pre><code class="language-text">meta-data/
</code></pre>
<p>Retrieving the <code>latest/meta-data/</code> resource in IMDS format:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER=latest/meta-data
curl -s &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER}&quot;
</code></pre>
<p>Output:</p>
<pre><code class="language-text">ami-id
reservation-id
</code></pre>
<p>Retrieving the <code>latest/meta-data/ami-id</code> resource in IMDS format:</p>
<pre><code class="language-bash">MMDS_IPV4_ADDR=169.254.170.2
RESOURCE_POINTER=latest/meta-data/ami-id
curl -s &quot;http://${MMDS_IPV4_ADDR}/${RESOURCE_POINTER}&quot;
</code></pre>
<p>Output:</p>
<pre><code class="language-text">ami-87654321
</code></pre>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<p><em>200</em> - <code>Ok</code></p>
<p>The request was successfully processed and a response was successfully formed.</p>
<p><em>400</em> - <code>Bad Request</code></p>
<p>The request was malformed.</p>
<p><em>401</em> - <code>Unauthorized</code></p>
<p>Only when using MMDS <code>V2</code>. The HTTP request either lacks the session token,
or the token specified is invalid. A token is invalid if it was not
generated using an HTTP <code>PUT</code> request or if it has expired.</p>
<p><em>404</em> - <code>Not Found</code></p>
<p>The requested resource can not be found in the MMDS data store.</p>
<p><em>405</em> - <code>Method Not Allowed</code></p>
<p>The HTTP request uses a not allowed HTTP method and a response with the <code>Allow</code>
header was formed. When using MMDS <code>V1</code>, this is returned for any HTTP method
other than <code>GET</code>. When MMDS <code>V2</code> is configured, the only accepted HTTP methods
are <code>PUT</code> and <code>GET</code>.</p>
<p><em>501</em> - <code>Not Implemented</code></p>
<p>The requested HTTP functionality is not supported by MMDS or the requested
resource is not supported in IMDS format.</p>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<h3 id="example-use-case-credential-rotation"><a class="header" href="#example-use-case-credential-rotation">Example use case: credential rotation</a></h3>
<p>For this example, the guest expects to find some sort of credentials (say, a
secret access key) by issuing a <code>GET</code> request to
<code>http://169.254.169.254/latest/meta-data/credentials/secret-key</code>. Most similar
use cases will encompass the following sequence of steps:</p>
<ol>
<li>Some agent running on the host sends a <code>PUT</code> request with the initial
contents of the MMDS, using the Firecracker API. This most likely takes
place before the microVM starts running, but may also happen at a later
time. Guest MMDS requests which arrive prior to contents being available
receive a <em>NotFound</em> response.</li>
<li>The contents are saved to MMDS.</li>
<li>The guest sends a <code>GET</code> request for the secret key, which is intercepted by
MMDS.</li>
<li>MMDS processes the request and sends back an HTTP response with the ensembled
secret key as a JSON string.</li>
</ol>
<p>After a while, the host agent decides to rotate the secret key. It does so by
updating the data store with a new value. This can be done via a <code>PUT</code> request
to the <code>/mmds</code> API resource, which replaces everything, or with a <code>PATCH</code>
request that only touches the desired key. This effectively triggers the first
two steps again.</p>
<p>The guest reads the new secret key, going one more time through the last three
steps. This can happen after a notification from the host agent, or discovered
via periodic polling, or some other mechanism. Since access to the data store
is thread safe, the guest can only receive either the old version, or the new
version of the key, and not some intermediate state caused by the update.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="mmds-design.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="snapshotting.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="mmds-design.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="snapshotting.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
