<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Jailer - Firecracker</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="CHARTER.html"><strong aria-hidden="true">2.</strong> Firecracker Charter</a></li><li class="chapter-item expanded "><a href="CODE_OF_CONDUCT.html"><strong aria-hidden="true">3.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="SECURITY.html"><strong aria-hidden="true">4.</strong> Security</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">5.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">6.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="dev-machine-setup.html"><strong aria-hidden="true">7.</strong> Development Machine Setup</a></li><li class="chapter-item expanded "><a href="api-change-runbook.html"><strong aria-hidden="true">8.</strong> API Change Runbook</a></li><li class="chapter-item expanded "><a href="RELEASE_POLICY.html"><strong aria-hidden="true">9.</strong> Releases</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">10.</strong> Design</a></li><li class="chapter-item expanded "><a href="prod-host-setup.html"><strong aria-hidden="true">11.</strong> Production Host Setup</a></li><li class="chapter-item expanded "><a href="network-setup.html"><strong aria-hidden="true">12.</strong> Network Setup</a></li><li class="chapter-item expanded "><a href="kernel-policy.html"><strong aria-hidden="true">13.</strong> Kernel Support Policy</a></li><li class="chapter-item expanded "><a href="SPECIFICATION.html"><strong aria-hidden="true">14.</strong> Specification</a></li><li class="chapter-item expanded "><a href="network-performance.html"><strong aria-hidden="true">15.</strong> Network Performance</a></li><li class="chapter-item expanded "><a href="FAQ.html"><strong aria-hidden="true">16.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="rootfs-and-kernel-setup.html"><strong aria-hidden="true">17.</strong> Creating Custom rootfs and kernel Images</a></li><li class="chapter-item expanded "><a href="ballooning.html"><strong aria-hidden="true">18.</strong> Ballooning</a></li><li class="chapter-item expanded "><a href="devctr-image.html"><strong aria-hidden="true">19.</strong> Development Container</a></li><li class="chapter-item expanded "><a href="device-api.html"><strong aria-hidden="true">20.</strong> Device API</a></li><li class="chapter-item expanded "><a href="entropy.html"><strong aria-hidden="true">21.</strong> Entropy</a></li><li class="chapter-item expanded "><a href="formal-verification.html"><strong aria-hidden="true">22.</strong> Formal Verification</a></li><li class="chapter-item expanded "><a href="initrd.html"><strong aria-hidden="true">23.</strong> initrd</a></li><li class="chapter-item expanded "><a href="jailer.html" class="active"><strong aria-hidden="true">24.</strong> Jailer</a></li><li class="chapter-item expanded "><a href="logger.html"><strong aria-hidden="true">25.</strong> Logger</a></li><li class="chapter-item expanded "><a href="metrics.html"><strong aria-hidden="true">26.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="seccomp.html"><strong aria-hidden="true">27.</strong> Seccomp</a></li><li class="chapter-item expanded "><a href="seccompiler.html"><strong aria-hidden="true">28.</strong> Seccompiler</a></li><li class="chapter-item expanded "><a href="tracing.html"><strong aria-hidden="true">29.</strong> Tracing</a></li><li class="chapter-item expanded "><a href="vsock.html"><strong aria-hidden="true">30.</strong> VSock</a></li><li class="chapter-item expanded "><a href="api-requests.html"><strong aria-hidden="true">31.</strong> API Requests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="actions.html"><strong aria-hidden="true">31.1.</strong> Actons</a></li><li class="chapter-item expanded "><a href="block-caching.html"><strong aria-hidden="true">31.2.</strong> Block Caching</a></li><li class="chapter-item expanded "><a href="block-io-engine.html"><strong aria-hidden="true">31.3.</strong> Block IO Engine</a></li><li class="chapter-item expanded "><a href="block-vhost-user.html"><strong aria-hidden="true">31.4.</strong> Block VHost User</a></li><li class="chapter-item expanded "><a href="patch-block.html"><strong aria-hidden="true">31.5.</strong> Patch Block</a></li><li class="chapter-item expanded "><a href="patch-network-interface.html"><strong aria-hidden="true">31.6.</strong> Patch Network Interface</a></li></ol></li><li class="chapter-item expanded "><a href="state-serialize.html"><strong aria-hidden="true">32.</strong> State Serialization Benchmarks</a></li><li class="chapter-item expanded "><a href="cpu-templates.html"><strong aria-hidden="true">33.</strong> CPU Templates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="boot-protocol.html"><strong aria-hidden="true">33.1.</strong> Boot Protocol</a></li><li class="chapter-item expanded "><a href="cpu-template-helper.html"><strong aria-hidden="true">33.2.</strong> CPU Template Helper</a></li><li class="chapter-item expanded "><a href="cpuid-normalization.html"><strong aria-hidden="true">33.3.</strong> CPUID Normalization</a></li></ol></li><li class="chapter-item expanded "><a href="mmds.html"><strong aria-hidden="true">34.</strong> MMDS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mmds-design.html"><strong aria-hidden="true">34.1.</strong> MMDS Design</a></li><li class="chapter-item expanded "><a href="mmds-user-guide.html"><strong aria-hidden="true">34.2.</strong> MMDS User Guide</a></li></ol></li><li class="chapter-item expanded "><a href="snapshotting.html"><strong aria-hidden="true">35.</strong> Snapshotting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="handling-page-faults-on-snapshot-resume.html"><strong aria-hidden="true">35.1.</strong> Handling Page Faults on Snapshot Resume</a></li><li class="chapter-item expanded "><a href="network-for-clones.html"><strong aria-hidden="true">35.2.</strong> Network For Clones</a></li><li class="chapter-item expanded "><a href="random-for-clones.html"><strong aria-hidden="true">35.3.</strong> Random For Clones</a></li><li class="chapter-item expanded "><a href="snapshot-editor.html"><strong aria-hidden="true">35.4.</strong> Snapshot Editor</a></li><li class="chapter-item expanded "><a href="snapshot-support.html"><strong aria-hidden="true">35.5.</strong> Snapshot Support</a></li><li class="chapter-item expanded "><a href="versioning.html"><strong aria-hidden="true">35.6.</strong> Versioning</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Firecracker</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-firecracker-jailer"><a class="header" href="#the-firecracker-jailer">The Firecracker Jailer</a></h1>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>The jailer is a program designed to isolate the Firecracker process in
order to enhance Firecracker's security posture. It is meant to address the
security needs of Firecracker only and is not intended to work with other
binaries. Additionally, each jailer binary should be used with a statically
linked Firecracker binary (with the default musl toolchain) of the same
version. Experimental gnu builds are not supported.</p>
<h2 id="jailer-usage"><a class="header" href="#jailer-usage">Jailer Usage</a></h2>
<p>The jailer is invoked in this manner:</p>
<pre><code class="language-bash">jailer --id &lt;id&gt; \
       --exec-file &lt;exec_file&gt; \
       --uid &lt;uid&gt; \
       --gid &lt;gid&gt;
       [--parent-cgroup &lt;relative_path&gt;]
       [--cgroup-version &lt;cgroup-version&gt;]
       [--cgroup &lt;cgroup&gt;]
       [--chroot-base-dir &lt;chroot_base&gt;]
       [--netns &lt;netns&gt;]
       [--resource-limit &lt;resource=value&gt;]
       [--daemonize]
       [--new-pid-ns]
       [--...extra arguments for Firecracker]
</code></pre>
<ul>
<li><code>id</code> is the unique VM identification string, which may contain alphanumeric
characters and hyphens. The maximum <code>id</code> length is currently 64 characters.</li>
<li><code>exec_file</code> is the path to the Firecracker binary that will be exec-ed by the
jailer. The filename must include the string <code>firecracker</code>. This is enforced
because the interaction with the jailer is Firecracker specific.</li>
<li><code>uid</code> and <code>gid</code> are the uid and gid the jailer switches to as it execs the
target binary.</li>
<li><code>parent-cgroup</code> is used to allow the placement of microvm cgroups in custom
nested hierarchies. By specifying this parameter, the jailer will create a
new cgroup named <code>id</code> for the microvm in the <code>&lt;cgroup_base&gt;/&lt;parent_cgroup&gt;</code>
subfolder. <code>cgroup_base</code> is the cgroup controller root for <code>cgroup v1</code> (e.g.
<code>/sys/fs/cgroup/cpu</code>) or the unified controller hierarchy for <code>cgroup v2</code> (
e.g. <code>/sys/fs/cgroup/unified</code>. <code>&lt;parent_cgroup&gt;</code> is a relative path within that
hierarchy. For example, if <code>--parent-cgroup all_uvms/external_uvms</code> is specified,
the jailer will write all cgroup parameters specified through <code>--cgroup</code> in
<code>/sys/fs/cgroup/&lt;controller_name&gt;/all_uvms/external_uvms/&lt;id&gt;</code>. By default, the
parent cgroup is <code>exec-file</code>.
If there are no <code>--cgroup</code> parameters specified and <code>--group-version=2</code> was
passed, then the jailer will move the process to the specified cgroup.</li>
<li><code>cgroup-version</code> is used to select which type of cgroup hierarchy to use for
the creation of cgroups. The default value is &quot;1&quot; which means that cgroups
specified with the <code>cgroup</code> argument will be created within a v1 hierarchy.
Supported options are &quot;1&quot; for cgroup-v1 and &quot;2&quot; for cgroup-v2.</li>
<li><code>cgroup</code> cgroups can be passed to the jailer to let it set the values
when the microVM process is spawned. The <code>--cgroup</code> argument must follow this format:
<code>&lt;cgroup_file&gt;=&lt;value&gt;</code> (e.g <code>cpuset.cpus=0</code>). This argument can be used multiple
times to set multiple cgroups. This is useful to avoid providing privileged permissions
to another process for setting the cgroups before or after the jailer is executed.
The <code>--cgroup</code> flag can help as well to set Firecracker process cgroups
before the VM starts running, with no need to create the entire cgroup
hierarchy manually (which requires privileged permissions).</li>
<li><code>chroot_base</code> represents the base folder where chroot jails are built. The
default is <code>/srv/jailer</code>.</li>
<li><code>netns</code> represents the path to a network namespace handle. If present, the
jailer will use this to join the associated network namespace.</li>
<li>For extra security and control over resource usage, <code>resource-limit</code> can be
used to set bounds to the process resources. The <code>--resource-limit</code> argument
must follow this format: <code>&lt;resource&gt;=&lt;value&gt;</code> (e.g <code>no-file=1024</code>) and can be
used multiple times to set multiple bounds. Current available resources that
can be limited using this argument are:
<ul>
<li><code>fsize</code>: The maximum size in bytes for files created by the process.</li>
<li><code>no-file</code>: Specifies a value one greater than the maximum file descriptor
number that can be opened by this process.</li>
</ul>
</li>
</ul>
<p>Here is an example on how to set multiple resource limits using this argument:</p>
<pre><code class="language-bash">--resource-limit fsize=250000000 --resource-limit no-file=1024
</code></pre>
<ul>
<li>When present, the <code>--daemonize</code> flag causes the jailer to call <code>setsid()</code> and
redirect all three standard I/O file descriptors to <code>/dev/null</code>.</li>
<li>When present, the <code>--new-pid-ns</code> flag causes the jailer to spawn the provided
binary into a new PID namespace.
It makes use of the libc <code>clone()</code> function with the <code>CLONE_NEWPID</code> flag.
As a result, the jailer and
the process running the exec file have different PIDs. The PID of the child
process is stored in the jail root directory inside <code>&lt;exec_file_name&gt;.pid</code>.</li>
<li>The jailer adheres to the &quot;end of command options&quot; convention, meaning
all parameters specified after <code>--</code> are forwarded to Firecracker. For
example, this can be paired with the <code>--config-file</code> Firecracker argument to
specify a configuration file when starting Firecracker via the jailer (the
file path and the resources referenced within must be valid relative to a
jailed Firecracker).
Please note the jailer already passes <code>--id</code> parameter to the
Firecracker process.</li>
</ul>
<h2 id="jailer-operation"><a class="header" href="#jailer-operation">Jailer Operation</a></h2>
<p>After starting, the Jailer goes through the following operations:</p>
<ul>
<li>Validate <strong>all provided paths</strong> and the VM <code>id</code>.</li>
<li>Close all open file descriptors based on <code>/proc/&lt;jailer-pid&gt;/fd</code> except
input, output and error.</li>
<li>Cleanup all environment variables received from the parent process.</li>
<li>Create the <code>&lt;chroot_base&gt;/&lt;exec_file_name&gt;/&lt;id&gt;/root</code> folder, which will be
henceforth referred to as <code>chroot_dir</code>. <code>exec_file_name</code> is the
last path component of <code>exec_file</code> (for example, that would be <code>firecracker</code>
for <code>/usr/bin/firecracker</code>). Nothing is done if the path already
exists (it should not, since <code>id</code> is supposed to be unique).</li>
<li>Copy <code>exec_file</code> to
<code>&lt;chroot_base&gt;/&lt;exec_file_name&gt;/&lt;id&gt;/root/&lt;exec_file_name&gt;</code>. This ensures the
new process will not share memory with any other Firecracker process.</li>
<li>Set resource bounds for current process and its children through
<code>--resource-limit</code> argument, by calling <code>setrlimit()</code> system call with the
specific resource argument. If no limits are provided, the jailer bounds
<code>no-file</code> to a maximum default value of 2048.</li>
<li>Create the <code>cgroup</code> sub-folders. The jailer can use either <code>cgroup v1</code>
or <code>cgroup v2</code>. On most systems, this is mounted by default in <code>/sys/fs/cgroup</code>
(should be mounted by the user otherwise). The jailer will parse
<code>/proc/mounts</code> to detect where each of the controllers required in <code>--cgroup</code>
can be found (multiple controllers may share the same path). For each identified
location (referred to as <code>&lt;cgroup_base&gt;</code>), the jailer creates the
<code>&lt;cgroup_base&gt;/&lt;parent_cgroup&gt;/&lt;id&gt;</code> subfolder, and writes the current pid
to <code>&lt;cgroup_base&gt;/&lt;parent_cgroup&gt;/&lt;id&gt;/tasks</code>. Also, the value passed for each
<code>&lt;cgroup_file&gt;</code> is written to the file. If <code>--node</code> is used the corresponding
values are written to the appropriate <code>cpuset.mems</code> and <code>cpuset.cpus</code> files.</li>
<li>Call <code>unshare()</code> into a new mount namespace, use <code>pivot_root()</code> to switch
the old system root mount point with a new one base in <code>chroot_dir</code>, switch
the current working directory to the new root, unmount the old root mount
point, and call <code>chroot</code> into the current directory.</li>
<li>Use <code>mknod</code> to create a <code>/dev/net/tun</code> equivalent inside the jail.</li>
<li>Use <code>mknod</code> to create a <code>/dev/kvm</code> equivalent inside the jail.</li>
<li>Use <code>chown</code> to change ownership of the <code>chroot_dir</code> (root path <code>/</code> as seen
by the jailed firecracker), <code>/dev/net/tun</code>, <code>/dev/kvm</code>. The ownership is
changed to the provided <code>uid:gid</code>.</li>
<li>If <code>--netns &lt;netns&gt;</code> is present, attempt to join the specified network
namespace.</li>
<li>If <code>--daemonize</code> is specified, call <code>setsid()</code> and redirect <code>STDIN</code>,
<code>STDOUT</code>, and <code>STDERR</code> to <code>/dev/null</code>.</li>
<li>If <code>--new-pid-ns</code> is specified, call <code>clone()</code> with <code>CLONE_NEWPID</code> flag
to spawn a new process within a new PID namespace.
The new process will assume the role of init(1) in the new namespace.
The parent will store child's PID inside <code>&lt;exec_file_name&gt;.pid</code>, while the child
drops privileges and <code>exec()</code>s into the <code>&lt;exec_file_name&gt;</code>, as described below.</li>
<li>Drop privileges via setting the provided <code>uid</code> and <code>gid</code>.</li>
<li>Exec into <code>&lt;exec_file_name&gt; --id=&lt;id&gt; --start-time-us=&lt;opaque&gt; --start-time-cpu-us=&lt;opaque&gt;</code> (and also forward
any extra arguments provided to the jailer after <code>--</code>, as mentioned in
the <strong>Jailer Usage</strong> section), where:
<ul>
<li><code>id</code>: (<code>string</code>) - The <code>id</code> argument provided to jailer.</li>
<li><code>opaque</code>: (<code>number</code>) time calculated by the jailer that it spent doing
its work.</li>
</ul>
</li>
</ul>
<h2 id="example-run-and-notes"><a class="header" href="#example-run-and-notes">Example Run and Notes</a></h2>
<p>Let’s assume Firecracker is available as <code>/usr/bin/firecracker</code>, and the jailer
can be found at <code>/usr/bin/jailer</code>. We pick the <strong>unique id
551e7604-e35c-42b3-b825-416853441234</strong>, and we choose to run on <strong>NUMA node
0</strong> (in order to isolate the process in the 0th NUMA node we need to set <code>cpuset.mems=0</code>
and <code>cpuset.cpus</code> equals to the CPUs of that NUMA node), using <strong>uid 123</strong>,
and <strong>gid 100</strong>. For this example, we are content with the default <code>/srv/jailer</code>
chroot base dir.</p>
<p>We start by running:</p>
<pre><code class="language-bash">/usr/bin/jailer --id 551e7604-e35c-42b3-b825-416853441234
--cgroup cpuset.mems=0 --cgroup cpuset.cpus=$(cat /sys/devices/system/node/node0/cpulist)
--exec-file /usr/bin/firecracker --uid 123 --gid 100 \
--netns /var/run/netns/my_netns --daemonize
</code></pre>
<p>After opening the file descriptors mentioned in the previous section, the
jailer will create the following resources (and all their prerequisites, such
as the path which contains them):</p>
<ul>
<li><code>/srv/jailer/firecracker/551e7604-e35c-42b3-b825-416853441234/root/firecracker</code>
(copied from <code>/usr/bin/firecracker</code>)</li>
</ul>
<p>We are going to refer to
<code>/srv/jailer/firecracker/551e7604-e35c-42b3-b825-416853441234/root</code>
as <code>&lt;chroot_dir&gt;</code>.</p>
<p>Let’s also assume the, <strong>cpuset</strong> cgroups are mounted at
<code>/sys/fs/cgroup/cpuset</code>. The jailer will create the following subfolder
(which will inherit settings from the parent cgroup):</p>
<ul>
<li><code>/sys/fs/cgroup/cpuset/firecracker/551e7604-e35c-42b3-b825-416853441234</code></li>
</ul>
<p>It’s worth noting that, whenever a folder already exists, nothing will be done,
and we move on to the next directory that needs to be created. This should only
happen for the common <code>firecracker</code> subfolder (but, as for creating the chroot
path before, we do not issue an error if folders directly associated with the
supposedly unique <code>id</code> already exist).</p>
<p>The jailer then writes the current pid to
<code>/sys/fs/cgroup/cpuset/firecracker/551e7604-e35c-42b3-b825-416853441234/tasks</code>,
It also writes <code>0</code> to
<code>/sys/fs/cgroup/cpuset/firecracker/551e7604-e35c-42b3-b825-416853441234/cpuset.mems</code>,
And the corresponding CPUs to
<code>/sys/fs/cgroup/cpuset/firecracker/551e7604-e35c-42b3-b825-416853441234/cpuset.cpus</code>.</p>
<p>Since the <code>--netns</code> parameter is specified in our example, the jailer opens
<code>/var/run/netns/my_netns</code> to get a file descriptor <code>fd</code>, uses
<code>setns(fd, CLONE_NEWNET)</code> to join the associated network namespace, and then
closes <code>fd</code>.</p>
<p>The <code>--daemonize</code> flag is also present, so the jailers opens <code>/dev/null</code> as
<strong>RW</strong> and keeps the associate file descriptor as <code>dev_null_fd</code> (we do this
before going inside the jail), to be used later.</p>
<p>Build the chroot jail. First, the jailer uses <code>unshare()</code> to enter a new mount
namespace, and changes the propagation of all mount points in the new namespace
to private using <code>mount(NULL, “/”, NULL, MS_PRIVATE | MS_REC, NULL)</code>, as a
prerequisite to <code>pivot_root()</code>. Another required operation is to bind mount
<code>&lt;chroot_dir&gt;</code> on top of itself using <code>mount(&lt;chroot_dir&gt;, &lt;chroot_dir&gt;, NULL, MS_BIND, NULL)</code>. At this point, the jailer creates the folder
<code>&lt;chroot_dir&gt;/old_root</code>, changes the current directory to <code>&lt;chroot_dir&gt;</code>,
and calls <code>syscall(SYS_pivot_root, “.”, “old_root”)</code>. The final steps of
building the jail are unmounting <code>old_root</code> using <code>umount2(“old_root”, MNT_DETACH)</code>, deleting <code>old_root</code> with <code>rmdir</code>, and finally calling
<code>chroot(“.”)</code> for good measure. From now, the process is jailed in
<code>&lt;chroot_dir&gt;</code>.</p>
<p>Create the special file <code>/dev/net/tun</code>, using <code>mknod(“/dev/net/tun”, S_IFCHR | S_IRUSR | S_IWUSR, makedev(10, 200))</code>, and then call <code>chown(“/dev/net/tun”, 123, 100)</code>, so Firecracker can use it after dropping privileges. This is
required to use multiple TAP interfaces when running jailed. Do the same for
<code>/dev/kvm</code>.</p>
<p>Change ownership of <code>&lt;chroot_dir&gt;</code> to <code>uid:gid</code> so that Firecracker can create
its API socket there.</p>
<p>Since the <code>--daemonize</code> flag is present, call <code>setsid()</code> to join a new
session, a new process group, and to detach from the controlling terminal.
Then, redirect standard file descriptors to <code>/dev/null</code> by calling
<code>dup2(dev_null_fd, STDIN)</code>, <code>dup2(dev_null_fd, STDOUT)</code>, and <code>dup2(dev_null_fd, STDERR)</code>. Close <code>dev_null_fd</code>, because it is no longer necessary.</p>
<p>Finally, the jailer switches the <code>uid</code> to <code>123</code>, and <code>gid</code> to <code>100</code>, and execs</p>
<pre><code class="language-console">./firecracker \
  --id=&quot;551e7604-e35c-42b3-b825-416853441234&quot; \
  --start-time-us=&lt;opaque&gt; \
  --start-time-cpu-us=&lt;opaque&gt;
</code></pre>
<p>Now firecracker creates the socket at
<code>/srv/jailer/firecracker/551e7604-e35c-42b3-b825-416853441234/root/&lt;api-sock&gt;</code>
to interact with the VM.</p>
<p>Note: default value for <code>&lt;api-sock&gt;</code> is <code>/run/firecracker.socket</code>.</p>
<h3 id="observations"><a class="header" href="#observations">Observations</a></h3>
<ul>
<li>The user must create hard links for (or copy) any resources which will be
provided to the VM via the API (disk images, kernel images, named pipes, etc)
inside the jailed root folder. Also, permissions must be properly managed for
these resources; for example the user which Firecracker runs as must have
both <strong>read and write permissions</strong> to the backing file for a RW block
device.</li>
<li>By default the VMs are not asigned to any NUMA node or pinned to any CPU.
The user must manage any fine tuning of resource partitioning via
cgroups, by using the <code>--cgroup</code> command line argument.</li>
<li>It’s up to the user to handle cleanup after running the jailer. One way to do
this involves registering handlers with the cgroup <code>notify_on_release</code>
mechanism, while being wary about potential race conditions (the instance
crashing before the subscription process is complete, for example).</li>
<li>For extra resilience, the <code>--new-pid-ns</code> flag enables the Jailer to exec the
binary file in a new PID namespace, in order to become a pseudo-init process.
Alternatively, the user can spawn the jailer in a new PID namespace via a
combination of <code>clone()</code> with the <code>CLONE_NEWPID</code> flag and <code>exec()</code>.</li>
<li>We run the jailer as the <code>root</code> user; it actually requires a more restricted
set of capabilities, but that's to be determined as features stabilize.</li>
<li>The jailer can only log messages to stdout/err for now, which is why the
logic associated with <code>--daemonize</code> runs towards the end, instead of the very
beginning. We are working on adding better logging capabilities.</li>
</ul>
<h2 id="caveats"><a class="header" href="#caveats">Caveats</a></h2>
<ul>
<li>
<p>If all the cgroup controllers are bunched up on a single mount point using
the &quot;all&quot; option, our current program logic will complain it cannot detect
individual controller mount points.</p>
</li>
<li>
<p><a href="https://github.com/firecracker-microvm/firecracker/issues/4287">#4287</a> When
starting a jailer with <code>--parent-cgroup</code> specified but no cgroup flags
specified, then the rules in the parent cgroup folder are ignored. To
work around, use a dummy cgroup parameter like <code>--cgroup=memory.max=max</code>.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="initrd.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="logger.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="initrd.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="logger.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
