<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Production Host Setup - Firecracker</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="CHARTER.html"><strong aria-hidden="true">2.</strong> Firecracker Charter</a></li><li class="chapter-item expanded "><a href="CODE_OF_CONDUCT.html"><strong aria-hidden="true">3.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="SECURITY.html"><strong aria-hidden="true">4.</strong> Security</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">5.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="CONTRIBUTING.html"><strong aria-hidden="true">6.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="dev-machine-setup.html"><strong aria-hidden="true">7.</strong> Development Machine Setup</a></li><li class="chapter-item expanded "><a href="api-change-runbook.html"><strong aria-hidden="true">8.</strong> API Change Runbook</a></li><li class="chapter-item expanded "><a href="RELEASE_POLICY.html"><strong aria-hidden="true">9.</strong> Releases</a></li><li class="chapter-item expanded "><a href="design.html"><strong aria-hidden="true">10.</strong> Design</a></li><li class="chapter-item expanded "><a href="prod-host-setup.html" class="active"><strong aria-hidden="true">11.</strong> Production Host Setup</a></li><li class="chapter-item expanded "><a href="network-setup.html"><strong aria-hidden="true">12.</strong> Network Setup</a></li><li class="chapter-item expanded "><a href="kernel-policy.html"><strong aria-hidden="true">13.</strong> Kernel Support Policy</a></li><li class="chapter-item expanded "><a href="SPECIFICATION.html"><strong aria-hidden="true">14.</strong> Specification</a></li><li class="chapter-item expanded "><a href="network-performance.html"><strong aria-hidden="true">15.</strong> Network Performance</a></li><li class="chapter-item expanded "><a href="FAQ.html"><strong aria-hidden="true">16.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="rootfs-and-kernel-setup.html"><strong aria-hidden="true">17.</strong> Creating Custom rootfs and kernel Images</a></li><li class="chapter-item expanded "><a href="ballooning.html"><strong aria-hidden="true">18.</strong> Ballooning</a></li><li class="chapter-item expanded "><a href="devctr-image.html"><strong aria-hidden="true">19.</strong> Development Container</a></li><li class="chapter-item expanded "><a href="device-api.html"><strong aria-hidden="true">20.</strong> Device API</a></li><li class="chapter-item expanded "><a href="entropy.html"><strong aria-hidden="true">21.</strong> Entropy</a></li><li class="chapter-item expanded "><a href="formal-verification.html"><strong aria-hidden="true">22.</strong> Formal Verification</a></li><li class="chapter-item expanded "><a href="initrd.html"><strong aria-hidden="true">23.</strong> initrd</a></li><li class="chapter-item expanded "><a href="jailer.html"><strong aria-hidden="true">24.</strong> Jailer</a></li><li class="chapter-item expanded "><a href="logger.html"><strong aria-hidden="true">25.</strong> Logger</a></li><li class="chapter-item expanded "><a href="metrics.html"><strong aria-hidden="true">26.</strong> Metrics</a></li><li class="chapter-item expanded "><a href="seccomp.html"><strong aria-hidden="true">27.</strong> Seccomp</a></li><li class="chapter-item expanded "><a href="seccompiler.html"><strong aria-hidden="true">28.</strong> Seccompiler</a></li><li class="chapter-item expanded "><a href="tracing.html"><strong aria-hidden="true">29.</strong> Tracing</a></li><li class="chapter-item expanded "><a href="vsock.html"><strong aria-hidden="true">30.</strong> VSock</a></li><li class="chapter-item expanded "><a href="api-requests.html"><strong aria-hidden="true">31.</strong> API Requests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="actions.html"><strong aria-hidden="true">31.1.</strong> Actons</a></li><li class="chapter-item expanded "><a href="block-caching.html"><strong aria-hidden="true">31.2.</strong> Block Caching</a></li><li class="chapter-item expanded "><a href="block-io-engine.html"><strong aria-hidden="true">31.3.</strong> Block IO Engine</a></li><li class="chapter-item expanded "><a href="block-vhost-user.html"><strong aria-hidden="true">31.4.</strong> Block VHost User</a></li><li class="chapter-item expanded "><a href="patch-block.html"><strong aria-hidden="true">31.5.</strong> Patch Block</a></li><li class="chapter-item expanded "><a href="patch-network-interface.html"><strong aria-hidden="true">31.6.</strong> Patch Network Interface</a></li></ol></li><li class="chapter-item expanded "><a href="state-serialize.html"><strong aria-hidden="true">32.</strong> State Serialization Benchmarks</a></li><li class="chapter-item expanded "><a href="cpu-templates.html"><strong aria-hidden="true">33.</strong> CPU Templates</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="boot-protocol.html"><strong aria-hidden="true">33.1.</strong> Boot Protocol</a></li><li class="chapter-item expanded "><a href="cpu-template-helper.html"><strong aria-hidden="true">33.2.</strong> CPU Template Helper</a></li><li class="chapter-item expanded "><a href="cpuid-normalization.html"><strong aria-hidden="true">33.3.</strong> CPUID Normalization</a></li></ol></li><li class="chapter-item expanded "><a href="mmds.html"><strong aria-hidden="true">34.</strong> MMDS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mmds-design.html"><strong aria-hidden="true">34.1.</strong> MMDS Design</a></li><li class="chapter-item expanded "><a href="mmds-user-guide.html"><strong aria-hidden="true">34.2.</strong> MMDS User Guide</a></li></ol></li><li class="chapter-item expanded "><a href="snapshotting.html"><strong aria-hidden="true">35.</strong> Snapshotting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="handling-page-faults-on-snapshot-resume.html"><strong aria-hidden="true">35.1.</strong> Handling Page Faults on Snapshot Resume</a></li><li class="chapter-item expanded "><a href="network-for-clones.html"><strong aria-hidden="true">35.2.</strong> Network For Clones</a></li><li class="chapter-item expanded "><a href="random-for-clones.html"><strong aria-hidden="true">35.3.</strong> Random For Clones</a></li><li class="chapter-item expanded "><a href="snapshot-editor.html"><strong aria-hidden="true">35.4.</strong> Snapshot Editor</a></li><li class="chapter-item expanded "><a href="snapshot-support.html"><strong aria-hidden="true">35.5.</strong> Snapshot Support</a></li><li class="chapter-item expanded "><a href="versioning.html"><strong aria-hidden="true">35.6.</strong> Versioning</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Firecracker</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="production-host-setup-recommendations"><a class="header" href="#production-host-setup-recommendations">Production Host Setup Recommendations</a></h1>
<p>Firecracker relies on KVM and on the processor virtualization features for
workload isolation. The host and guest kernels and host microcode must be
regularly patched in accordance with your distribution's security advisories
such as <a href="https://alas.aws.amazon.com/alas2023.html">ALAS</a> for Amazon Linux.</p>
<p>Security guarantees and defense in depth can only be upheld, if the following
list of recommendations are implemented in production.</p>
<h2 id="firecracker-configuration"><a class="header" href="#firecracker-configuration">Firecracker Configuration</a></h2>
<h3 id="seccomp"><a class="header" href="#seccomp">Seccomp</a></h3>
<p>Firecracker uses
<a href="https://www.kernel.org/doc/Documentation/prctl/seccomp_filter.txt">seccomp</a>
filters to limit the system calls allowed by the host OS to the required
minimum.</p>
<p>By default, Firecracker uses the most restrictive filters, which is the
recommended option for production usage.</p>
<p>Production usage of the <code>--seccomp-filter</code> or <code>--no-seccomp</code> parameters is not
recommended.</p>
<h3 id="8250-serial-device"><a class="header" href="#8250-serial-device">8250 Serial Device</a></h3>
<p>Firecracker implements the 8250 serial device, which is visible from the guest
side and is tied to the Firecracker/non-daemonized jailer process stdout.
Without proper handling, because the guest has access to the serial device,
this can lead to unbound memory or storage usage on the host side. Firecracker
does not offer users the option to limit serial data transfer, nor does it
impose any restrictions on stdout handling. Users are responsible for handling
the memory and storage usage of the Firecracker process stdout. We suggest
using any upper-bounded forms of storage, such as fixed-size or ring buffers,
using programs like <code>journald</code> or <code>logrotate</code>, or redirecting to <code>/dev/null</code>
or a named pipe. Furthermore, we do not recommend that users enable the serial
device in production. To disable it in the guest kernel, use the
<code>8250.nr_uarts=0</code> boot argument when configuring the boot source. Please be
aware that the device can be reactivated from within the guest even if it was
disabled at boot.</p>
<p>If Firecracker's <code>stdout</code> buffer is non-blocking and full (assuming it has a
bounded size), any subsequent writes will fail, resulting in data loss, until
the buffer is freed.</p>
<h3 id="log-files"><a class="header" href="#log-files">Log files</a></h3>
<p>Firecracker outputs logging data into a named pipe, socket, or file using the
path specified in the <code>log_path</code> field of logger configuration. Firecracker can
generate log data as a result of guest operations and therefore the guest can
influence the volume of data written in the logs. Users are responsible
for consuming and storing this data safely. We suggest using any upper-bounded
forms of storage, such as fixed-size or ring buffers, programs like <code>journald</code>
or <code>logrotate</code>, or redirecting to a named pipe.</p>
<h3 id="logging-and-performance"><a class="header" href="#logging-and-performance">Logging and performance</a></h3>
<p>We recommend adding <code>quiet loglevel=1</code> to the host kernel command line to limit
the number of messages written to the serial console. This is because some host
configurations can have an effect on Firecracker's performance as the process
will generate host kernel logs during normal operations.</p>
<p>The most recent example of this was the addition of <code>console=ttyAMA0</code> host
kernel command line argument on one of our testing setups. This enabled console
logging, which degraded the snapshot restore time from 3ms to 8.5ms on
<code>aarch64</code>. In this case, creating the tap device for snapshot restore
generated host kernel logs, which were very slow to write.</p>
<h3 id="logging-and-signal-handlers"><a class="header" href="#logging-and-signal-handlers">Logging and signal handlers</a></h3>
<p>Firecracker installs custom signal handlers for some of the POSIX signals, such
as SIGSEGV, SIGSYS, etc.</p>
<p>The custom signal handlers used by Firecracker are not async-signal-safe, since
they write logs and flush the metrics, which use locks for synchronization.
While very unlikely, it is possible that the handler will intercept a signal on
a thread which is already holding a lock to the log or metrics buffer.
This can result in a deadlock, where the specific Firecracker thread becomes
unresponsive.</p>
<p>While there is no security impact caused by the deadlock, we recommend that
customers have an overwatcher process on the host, that periodically looks
for Firecracker processes that are unresponsive, and kills them, by SIGKILL.</p>
<h2 id="jailer-configuration"><a class="header" href="#jailer-configuration">Jailer Configuration</a></h2>
<p>For assuring secure isolation in production deployments, Firecracker should be
started using the <code>jailer</code> binary that's part of each Firecracker release, or
executed under process constraints equal or more restrictive than those in the jailer.
For more about Firecracker sandboxing please see
<a href="design.html">Firecracker design</a></p>
<p>The Jailer process applies
<a href="https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt">cgroup</a>,
namespace isolation and drops privileges of the Firecracker process.</p>
<p>To set up the jailer correctly, you'll need to:</p>
<ul>
<li>Create a dedicated non-privileged POSIX user and group to run Firecracker
under. Use the created POSIX user and group IDs in Jailer's <code>--uid &lt;uid&gt;</code>
and <code>--gid &lt;gid&gt;</code> flags, respectively. This will run the Firecracker as
the created non-privileged user and group. All file system resources used for
Firecracker should be owned by this user and group. Apply least privilege to
the resource files owned by this user and group to prevent other accounts from
unauthorized file access.
When running multiple Firecracker instances it is recommended that each runs
with its unique <code>uid</code> and <code>gid</code> to provide an extra layer of security for
their individually owned resources in the unlikely case where any one of the
jails is broken out of.</li>
</ul>
<p>Firecracker's customers are strongly advised to use the provided
<code>resource-limits</code> and <code>cgroup</code> functionalities encapsulated within jailer,
in order to control Firecracker's resource consumption in a way that makes
the most sense to their specific workload. While aiming to provide as much
control as possible, we cannot enforce aggressive default constraints
resources such as memory or CPU because these are highly dependent on the
workload type and usecase.</p>
<p>Here are some recommendations on how to limit the process's resources:</p>
<h3 id="disk"><a class="header" href="#disk">Disk</a></h3>
<ul>
<li>
<p><code>cgroup</code> provides a
<a href="https://www.kernel.org/doc/Documentation/cgroup-v1/blkio-controller.txt">Block IO Controller</a>
which allows users to control I/O operations through the following files:</p>
<ul>
<li><code>blkio.throttle.io_serviced</code> - bounds the number of I/Os issued to disk</li>
<li><code>blkio.throttle.io_service_bytes</code> - sets a limit on the number of bytes
transferred to/from the disk</li>
</ul>
</li>
<li>
<p>Jailer's <code>resource-limit</code> provides control on the disk usage through:</p>
<ul>
<li><code>fsize</code> - limits the size in bytes for files created by the process</li>
<li><code>no-file</code> - specifies a value greater than the maximum file
descriptor number that can be opened by the process. If not specified,
it defaults to 4096.</li>
</ul>
</li>
</ul>
<h3 id="memory"><a class="header" href="#memory">Memory</a></h3>
<ul>
<li><code>cgroup</code> provides a
<a href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt">Memory Resource Controller</a>
to allow setting upper limits to memory usage:
<ul>
<li><code>memory.limit_in_bytes</code> - bounds the memory usage</li>
<li><code>memory.memsw.limit_in_bytes</code> - limits the memory+swap usage</li>
<li><code>memory.soft_limit_in_bytes</code> -  enables flexible sharing of memory. Under
normal circumstances, control groups are allowed to use as much of the
memory as needed, constrained only by their hard limits set with the
<code>memory.limit_in_bytes</code> parameter. However, when the system detects
memory contention or low memory, control groups are forced to restrict
their consumption to their soft limits.</li>
</ul>
</li>
</ul>
<h3 id="vcpu"><a class="header" href="#vcpu">vCPU</a></h3>
<ul>
<li><code>cgroup</code>’s
<a href="https://www.kernel.org/doc/Documentation/cgroup-v1/cpuacct.txt">CPU Controller</a>
can guarantee a minimum number of CPU shares when a system is busy and
provides CPU bandwidth control through:
<ul>
<li><code>cpu.shares</code> - limits the amount of CPU that each group it is expected to
get. The percentage of CPU assigned is the value of shares divided by the
sum of all shares in all <code>cgroups</code> in the same level</li>
<li><code>cpu.cfs_period_us</code> - bounds the duration in us of each scheduler period,
for bandwidth decisions. This defaults to 100ms</li>
<li><code>cpu.cfs_quota_us</code> - sets the maximum time in microseconds during each
<code>cfs_period_us</code> for which the current group will be allowed to run</li>
<li><code>cpuacct.usage_percpu</code> - limits the CPU time, in ns, consumed by the
process in the group, separated by CPU</li>
</ul>
</li>
</ul>
<p>Additional details of Jailer features can be found in the
<a href="jailer.html">Jailer documentation</a>.</p>
<h2 id="host-security-configuration"><a class="header" href="#host-security-configuration">Host Security Configuration</a></h2>
<h3 id="constrain-cpu-overhead-caused-by-kvm-pit-kernel-threads"><a class="header" href="#constrain-cpu-overhead-caused-by-kvm-pit-kernel-threads">Constrain CPU overhead caused by kvm-pit kernel threads</a></h3>
<p>The current implementation results in host CPU usage increase on x86 CPUs when
a guest injects timer interrupts with the help of kvm-pit kernel thread.
kvm-pit kthread is by default part of the root cgroup.</p>
<p>To mitigate the CPU overhead we recommend two system level configurations.</p>
<ol>
<li>Use an external agent to move the <code>kvm-pit/&lt;pid of firecracker&gt;</code> kernel
thread in the microVM’s cgroup (e.g., created by the Jailer).
This cannot be done by Firecracker since the thread is created by the Linux
kernel after guest start, at which point Firecracker is de-privileged.</li>
<li>Configure the kvm limit to a lower value. This is a system-wide
configuration available to users without Firecracker or Jailer changes.
However, the same limit applies to APIC timer events, and users will need
to test their workloads in order to apply this mitigation.</li>
</ol>
<p>To modify the kvm limit for interrupts that can be injected in a second.</p>
<ol>
<li><code>sudo modprobe -r (kvm_intel|kvm_amd) kvm</code></li>
<li><code>sudo modprobe kvm min_timer_period_us={new_value}</code></li>
<li><code>sudo modprobe (kvm_intel|kvm_amd)</code></li>
</ol>
<p>To have this change persistent across boots we can append the option to
<code>/etc/modprobe.d/kvm.conf</code>:</p>
<p><code>echo &quot;options kvm min_timer_period_us=&quot; &gt;&gt; /etc/modprobe.d/kvm.conf</code></p>
<h3 id="mitigating-network-flooding-issues"><a class="header" href="#mitigating-network-flooding-issues">Mitigating Network flooding issues</a></h3>
<p>Network can be flooded by creating connections and sending/receiving a
significant amount of requests. This issue can be mitigated either by
configuring rate limiters for the network interface as explained within
<a href="api_requests/patch-network-interface.html">Network Interface documentation</a>,
or by using one of the tools presented below:</p>
<ul>
<li><code>tc qdisc</code> - manipulate traffic control settings by configuring filters.</li>
</ul>
<p>When traffic enters a classful qdisc, the filters are consulted and the
packet is enqueued into one of the classes within. Besides
containing other qdiscs, most classful qdiscs perform rate control.</p>
<ul>
<li><code>netnamespace</code> and <code>iptables</code>
<ul>
<li><code>--pid-owner</code> -  can be used to match packets based on the PID that was
responsible for them</li>
<li><code>connlimit</code> - restricts the number of connections for a destination IP
address/from a source IP address, as well as limit the bandwidth</li>
</ul>
</li>
</ul>
<h3 id="mitigating-noisy-neighbour-storage-device-contention"><a class="header" href="#mitigating-noisy-neighbour-storage-device-contention">Mitigating Noisy-Neighbour Storage Device Contention</a></h3>
<p>Data written to storage devices is managed in Linux with a page cache.
Updates to these pages are written through to their mapped storage
devices asynchronously at the host operating system's discretion.
As a result, high storage output can result in this cache being
filled quickly resulting in a backlog which can slow down I/O of
other guests on the host.</p>
<p>To protect the resource access of the guests, make sure to tune each Firecracker
process via the following tools:</p>
<ul>
<li><a href="jailer.html">Jailer</a>: A wrapper environment designed to contain Firecracker
and strictly control what the process and its guest has
access to. Take note of the
<a href="jailer.html#jailer-operation">jailer operations guide</a>,
paying particular note to the <code>--resource-limit</code> parameter.</li>
<li>Rate limiting: Rate limiting functionality is supported for both networking
and storage devices and is configured by the operator of the
environment that launches the Firecracker process and its
associated guest.
See the <a href="api_requests/patch-block.html">block device documentation</a>
for examples of calling the API to configure rate limiting.</li>
</ul>
<h3 id="disabling-swapping-to-disk-or-enabling-secure-swap"><a class="header" href="#disabling-swapping-to-disk-or-enabling-secure-swap">Disabling swapping to disk or enabling secure swap</a></h3>
<p>Memory pressure on a host can cause memory to be written to drive storage when
swapping is enabled. Disabling swap mitigates data remanence issues related to
having guest memory contents on microVM storage devices.</p>
<p>Verify that swap is disabled by running:</p>
<pre><code class="language-bash">grep -q &quot;/dev&quot; /proc/swaps &amp;&amp; \
echo &quot;swap partitions present (Recommendation: no swap)&quot; \
|| echo &quot;no swap partitions (OK)&quot;
</code></pre>
<h3 id="mitigating-hardware-vulnerabilities"><a class="header" href="#mitigating-hardware-vulnerabilities">Mitigating hardware vulnerabilities</a></h3>
<blockquote>
<p><strong>Note</strong> Firecracker is not able to mitigate host's hardware vulnerabilities.
Adequate mitigations need to be put in place when configuring the host.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong> Firecracker is designed to provide isolation boundaries between
microVMs running in different Firecracker processes. It is strongly recommended
that each Firecracker process corresponds to a workload of a single tenant.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong> For security and stability reasons it is highly recommended to load
updated microcode as soon as possible. Aside from keeping the system firmware
up-to-date, when the kernel is used to load updated microcode of the CPU this
should be done as early as possible in the boot process.</p>
</blockquote>
<h4 id="side-channel-attacks"><a class="header" href="#side-channel-attacks">Side channel attacks</a></h4>
<p>It is strongly recommended that users follow the
<a href="https://docs.kernel.org/admin-guide/hw-vuln/index.html">Linux kernel documentation on hardware vulnerabilities</a>
when configuring mitigations against side channel attacks including &quot;Spectre&quot;
and &quot;Meltdown&quot; attacks
(see <a href="https://docs.kernel.org/arch/x86/pti.html">Page Table Isolation</a>
and <a href="https://docs.kernel.org/userspace-api/spec_ctrl.html">Speculation Control</a>).</p>
<p>Additionally users should consider disabling
<a href="https://www.kernel.org/doc/html/latest/admin-guide/mm/ksm.html">Kernel Samepage Merging</a>
to mitigate <a href="https://eprint.iacr.org/2013/448.pdf">side channel issues</a>
relying on the page deduplication for revealing what memory pages are
accessed by another process.</p>
<h5 id="use-memory-with-rowhammer-mitigation-support"><a class="header" href="#use-memory-with-rowhammer-mitigation-support">Use memory with Rowhammer mitigation support</a></h5>
<p>Rowhammer is a memory side-channel issue that can lead to unauthorized cross-
process memory changes.</p>
<p>Using DDR4 memory that supports Target Row Refresh (TRR) with error-correcting
code (ECC) is recommended. Use of pseudo target row refresh (pTRR) for systems
with pTRR-compliant DDR3 memory can help mitigate the issue, but it also
incurs a performance penalty.</p>
<h5 id="vendor-specific-recommendations"><a class="header" href="#vendor-specific-recommendations">Vendor-specific recommendations</a></h5>
<p>For vendor-specific recommendations, please consult the resources below:</p>
<ul>
<li>Intel: <a href="https://www.intel.com/content/www/us/en/developer/topic-technology/software-security-guidance/overview.html">Software Security Guidance</a></li>
<li>AMD: <a href="https://www.amd.com/en/resources/product-security.html">AMD Product Security</a></li>
<li>ARM: <a href="https://developer.arm.com/support/arm-security-updates/speculative-processor-vulnerability">Speculative Processor Vulnerability</a></li>
</ul>
<h5 id="arm-only-physical-counter-directly-passed-through-to-the-guest"><a class="header" href="#arm-only-physical-counter-directly-passed-through-to-the-guest">[ARM only] Physical counter directly passed through to the guest</a></h5>
<p>On ARM, the physical counter (i.e <code>CNTPCT</code>) it is returning the
<a href="https://elixir.free-electrons.com/linux/v4.14.203/source/virt/kvm/arm/hyp/timer-sr.c#L63">actual EL1 physical counter value of the host</a>. From the discussions before
merging this change <a href="https://lists.cs.columbia.edu/pipermail/kvmarm/2017-January/023323.html">upstream</a>, this seems like a conscious design decision
of the ARM code contributors, giving precedence to performance over the ability
to trap and control this in the hypervisor.</p>
<h5 id="verification"><a class="header" href="#verification">Verification</a></h5>
<p><a href="https://github.com/speed47/spectre-meltdown-checker">spectre-meltdown-checker script</a>
can be used to assess host's resilience against several transient execution
CVEs and receive guidance on how to mitigate them.</p>
<p>The script is used in integration tests by the Firecracker team. It can be
downloaded and executed like:</p>
<pre><code class="language-bash"># Read https://meltdown.ovh before running it.
wget -O - https://meltdown.ovh | bash
</code></pre>
<h3 id="linux-61-boot-time-regressions"><a class="header" href="#linux-61-boot-time-regressions">Linux 6.1 boot time regressions</a></h3>
<p>Linux 6.1 introduced some regressions in the time it takes to boot a VM, for the
x86_64 architecture. They can be mitigated depending on the CPU and the version
of cgroups in use.</p>
<h4 id="explanation"><a class="header" href="#explanation">Explanation</a></h4>
<p>The regression happens in the <code>KVM_CREATE_VM</code> ioctl and there are two factors
that cause the issue:</p>
<ol>
<li>In the implementation of the mitigation for the iTLB multihit vulnerability,
KVM creates a worker thread called <code>kvm-nx-lpage-recovery</code>. This thread is
responsible for recovering huge pages split when the mitigation kicks-in. In
the process of creating this thread, KVM calls <code>cgroup_attach_task_all()</code> to
move it to the same cgroup used by the hypervisor thread</li>
<li>In kernel v4.4, upstream converted a cgroup per process read-write semaphore
into a per-cpu read-write semaphore to allow to perform operations across
multiple processes
(<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?&amp;id=1ed1328792ff46e4bb86a3d7f7be2971f4549f6c">commit</a>).
It was found that this conversion introduced high latency for write paths,
which mainly includes moving tasks between cgroups. This was fixed in kernel
v4.9 by
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?&amp;id=3942a9bd7b5842a924e99ee6ec1350b8006c94ec">commit</a>
which chose to favor writers over readers since moving tasks between cgroups
is a common operation for Android. However, In kernel 6.0, upstream decided
to revert back again and favor readers over writers re-introducing the
original behavior of the rw semaphore
(<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?&amp;id=6a010a49b63ac8465851a79185d8deff966f8e1a">commit</a>).
At the same time, this commit provided an option called favordynmods to favor
writers over readers.</li>
<li>Since the <code>kvm-nx-lpage-recovery</code> thread creation and its cgroup change is done
in the <code>KVM_CREATE_VM</code> call, the high latency we observe in 6.1 is due to the
upstream decision to favor readers over writers for this per-cpu rw
semaphore. While the 4.14 and 5.10 kernels favor writers over readers.</li>
</ol>
<p>The first step is to check if the host is vulnerable to iTLB multihit. Look at
the value of <code>cat /sys/devices/system/cpu/vulnerabilities/itlb_multihit</code>. If it
does says <code>Not affected</code>, the host is not vulnerable and you can apply
mitigation 2, and optionally 1 for best results. Otherwise it is vulnerable and
you can only apply mitigation 1.</p>
<h4 id="mitigation-1-favordynmods"><a class="header" href="#mitigation-1-favordynmods">Mitigation 1: <code>favordynmods</code></a></h4>
<p>The mitigation in this case is to enable <code>favordynmods</code> in cgroupsv1 or
cgroupsv2. This changes the behavior of all cgroups in the host, and makes it
closer to the performance of Linux 5.10 and 4.14.</p>
<p>For cgroupsv2, run this command:</p>
<pre><code class="language-sh">sudo mount -o remount,favordynmods /sys/fs/cgroup
</code></pre>
<p>For cgroupsv1, remounting with <code>favordynmods</code> is not supported, so it has to be
done at boot time, through a kernel command line option<sup class="footnote-reference"><a href="#1">1</a></sup>. Add
<code>cgroup_favordynmods=true</code> to your kernel command line in GRUB. Refer to your
distribution's documentation for where to make this change<sup class="footnote-reference"><a href="#2">2</a></sup></p>
<p><sup class="footnote-reference"><a href="#2">2</a></sup> Look for <code>GRUB_CMDLINE_LINUX</code> in file <code>/etc/default/grub</code> in RPM-based
systems, and <a href="https://wiki.ubuntu.com/Kernel/KernelBootParameters">this doc for
Ubuntu</a>.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>this command line option is still unreleased at the moment of writing, but
will be part of 6.7 and may be backported to 6.1:
<a href="https://lore.kernel.org/lkml/ZR2zsZIung0-mWii@slm.duckdns.org/">https://lore.kernel.org/lkml/ZR2zsZIung0-mWii@slm.duckdns.org/</a></p>
</div>
<h4 id="mitigation-2-kvmnx_huge_pagesnever"><a class="header" href="#mitigation-2-kvmnx_huge_pagesnever">Mitigation 2: <code>kvm.nx_huge_pages=never</code></a></h4>
<p>This mitigation is preferred to the previous one as it is less invasive (it
doesn't affect other cgroups), but it can also be combined with the cgroups
mitigation.</p>
<pre><code class="language-sh">KVM_VENDOR_MOD=$(lsmod |grep -P &quot;^kvm_(amd|intel)&quot; | awk '{print $1}')
sudo modprobe -r $KVM_VENDOR_MOD kvm
sudo modprobe kvm nx_huge_pages=never
sudo modprobe $KVM_VENDOR_MOD
</code></pre>
<p>To validate that the change took effect, the file
<code>/sys/module/kvm/parameters/nx_huge_pages</code> should say <code>never</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="design.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="network-setup.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="design.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="network-setup.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
